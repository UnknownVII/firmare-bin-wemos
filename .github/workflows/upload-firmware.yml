name: Firmware Release

on:
  push:
    branches:
      - master

jobs:
  release:
    name: ğŸš€ Upload firmware to GitHub Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed to create release and upload assets

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ·ï¸ Delete old 'latest' tag if exists
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git tag -d latest || true
          git push origin :refs/tags/latest || true

      - name: ğŸ·ï¸ Create 'latest' tag
        run: |
          git tag latest
          git push origin latest --force

      - name: ğŸš€ Create GitHub Release with 'latest' tag
        uses: softprops/action-gh-release@v2
        with:
          name: Latest Firmware
          tag_name: latest
          files: build/esp8266.esp8266.d1_mini_clone/*.bin
          prerelease: false
          draft: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
